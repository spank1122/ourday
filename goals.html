<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Goals ‚ú®</title>

  <link rel="stylesheet" href="assets/theme.css">
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <meta property="og:title" content="Our Day üíó">
  <meta property="og:description" content="‡∏´‡∏°‡∏π‡∏≠‡πâ‡∏ß‡∏ô √ó ‡∏´‡∏°‡∏π‡∏à‡∏¥‡πã‡∏ß">
  <meta property="og:image" content="assets/og.png">
  <meta property="og:type" content="website">
  <meta name="theme-color" content="#ff5e9a">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body{
      min-height:100vh;
      font-family:Poppins, sans-serif;
      background: linear-gradient(135deg, #ffe6ee 0%, #fff0f7 50%, #ffe6ee 100%);
      padding:120px 20px 40px;
    }

    .wrap{ max-width: 1050px; margin: 0 auto; }

    .page-head{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin-bottom: 16px;
    }
    .h1{
      font-size: 2.1rem;
      color:#ff6b95;
      font-weight: 800;
      text-shadow: 0 10px 30px rgba(255,107,149,.20);
      line-height: 1.1;
    }
    .sub{
      margin-top: 6px;
      color: rgba(255,94,154,.65);
      font-weight: 700;
      font-size: .95rem;
    }

    .btn-small{
      border:none; cursor:pointer;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 800;
      background: linear-gradient(135deg,#ff5e9a,#ff8ab9);
      color:#fff;
      box-shadow: 0 14px 35px rgba(255,107,149,.25);
      transition:.18s ease;
    }
    .btn-small:hover{ transform: translateY(-2px); box-shadow: 0 18px 45px rgba(255,107,149,.32); }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
    }

    .card{
      grid-column: span 6;
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(255,107,149,.16);
      border-radius: 26px;
      padding: 18px 18px 16px;
      box-shadow: 0 18px 60px rgba(255,107,149,.16);
      backdrop-filter: blur(16px);
      cursor:pointer;
      transition:.18s ease;
      position:relative;
      overflow:hidden;
    }
    .card:hover{ transform: translateY(-4px); box-shadow: 0 22px 70px rgba(255,107,149,.22); }

    .pill{
      position:absolute;
      top:14px; right:14px;
      padding: 7px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: .78rem;
      border: 1px solid rgba(255,107,149,.20);
      background: rgba(255,107,149,.10);
      color:#ff5e9a;
    }
    .pill.ok{ background: rgba(46, 204, 113, .12); border-color: rgba(46,204,113,.25); color: rgba(30,140,80,1); }
    .pill.fail{ background: rgba(255,71,87,.10); border-color: rgba(255,71,87,.20); color: rgba(255,71,87,1); }

    .title{
      font-weight: 900;
      color:#ff5e9a;
      font-size: 1.15rem;
      margin-bottom: 8px;
      padding-right: 88px;
    }

    .meta{
      display:flex; flex-wrap:wrap; gap:10px;
      color: rgba(26,37,47,.65);
      font-weight: 700;
      font-size: .9rem;
    }

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 16px;
      background: rgba(255,107,149,.08);
      border: 1px solid rgba(255,107,149,.14);
    }
    .tag b{ color:#ff5e9a; }

    .note{
      margin-top: 12px;
      color: rgba(26,37,47,.65);
      font-weight: 600;
      line-height: 1.35;
      min-height: 20px;
    }

    .progress{
      margin-top: 14px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,107,149,.10);
      border: 1px solid rgba(255,107,149,.14);
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, #ff5e9a, #ff8ab9, #ffd1e3);
      transition:.25s ease;
    }

    /* Modal */
    .overlay{
      position: fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center; justify-content:center;
      padding: 22px;
      z-index: 9999;
    }
    .overlay.show{ display:flex; }

    .modal{
      width: min(720px, 100%);
      background: rgba(255,255,255,.95);
      border-radius: 28px;
      border: 1px solid rgba(255,107,149,.18);
      box-shadow: 0 30px 90px rgba(0,0,0,.35);
      padding: 18px;
      backdrop-filter: blur(18px);
      animation: pop .18s ease;
    }
    @keyframes pop{ from{ transform: translateY(12px) scale(.98); opacity:0; } to { transform:none; opacity:1; } }

    .modal-head{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding: 4px 4px 10px;
    }
    .modal-head h3{
      margin:0;
      font-size: 1.25rem;
      color:#ff5e9a;
      font-weight: 900;
    }
    .x{
      width: 44px; height:44px;
      border-radius: 14px;
      border: 1px solid rgba(255,107,149,.20);
      background: rgba(255,107,149,.08);
      cursor:pointer;
      font-weight: 900;
      color:#ff5e9a;
      display:flex; align-items:center; justify-content:center;
    }

    .modal-body{ padding: 8px 6px 6px; }

    .row3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    .box{
      background: rgba(255,107,149,.06);
      border: 1px solid rgba(255,107,149,.14);
      border-radius: 22px;
      padding: 12px 12px;
    }
    .box .k{ color: rgba(255,94,154,.75); font-weight: 900; font-size: .82rem; }
    .box .v{ margin-top: 6px; font-weight: 900; color: rgba(26,37,47,.85); }

    .modal-note{
      margin-top: 8px;
      background: rgba(255,255,255,.8);
      border: 1px solid rgba(255,107,149,.14);
      border-radius: 20px;
      padding: 12px;
      color: rgba(26,37,47,.70);
      font-weight: 650;
      line-height: 1.4;
      min-height: 44px;
    }

    .actions{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top: 14px;
      justify-content: flex-end;
    }
    .btn{
      border:none; cursor:pointer;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      transition:.16s ease;
    }
    .btn-doing{ background: rgba(255,107,149,.10); color:#ff5e9a; border:1px solid rgba(255,107,149,.18); }
    .btn-ok{ background: rgba(46,204,113,.14); color: rgba(30,140,80,1); border:1px solid rgba(46,204,113,.22); }
    .btn-fail{ background: rgba(255,71,87,.12); color: rgba(255,71,87,1); border:1px solid rgba(255,71,87,.18); }
    .btn:hover{ transform: translateY(-1px); }

    /* Create Modal form */
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    .form .full{ grid-column: 1 / -1; }
    .label{ color: rgba(255,94,154,.78); font-weight: 900; font-size:.85rem; margin-bottom: 6px; }
    .input, .select, .textarea{
      width:100%;
      border-radius: 18px;
      border: 1px solid rgba(255,107,149,.18);
      padding: 12px 12px;
      font-family: inherit;
      outline: none;
      background: rgba(255,255,255,.9);
      font-weight: 750;
      color: rgba(26,37,47,.85);
    }
    .textarea{ min-height: 90px; resize: vertical; }

    .hint{ color: rgba(26,37,47,.55); font-weight: 700; font-size: .85rem; margin-top: 6px; }

    @media (max-width: 900px){
      .card{ grid-column: span 12; }
      .row3{ grid-template-columns: 1fr; }
      .form{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div id="appNav"></div>
  <div id="pageFade"></div>

  <div class="wrap">
    <div class="page-head">
      <div>
        <div class="h1">Goals üíó</div>
        <div class="sub">‡∏î‡∏π‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ + ‡∏Å‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡∏ï‡∏¥‡πä‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
      </div>
      <button class="btn-small" id="btnOpenCreate">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° Goal</button>
    </div>

    <div class="grid" id="goalsGrid"></div>
  </div>

  <!-- Detail Modal -->
  <div class="overlay" id="detailOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <h3 id="dTitle">Goal</h3>
        <button class="x" id="btnCloseDetail">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="row3">
          <div class="box">
            <div class="k">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</div>
            <div class="v" id="dType">‚Äî</div>
          </div>
          <div class="box">
            <div class="k">‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div>
            <div class="v" id="dDue">‚Äî</div>
          </div>
          <div class="box">
            <div class="k">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="v" id="dStatus">‚Äî</div>
          </div>
        </div>

        <div class="row3" id="moneyRow" style="display:none;">
          <div class="box">
            <div class="k">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</div>
            <div class="v" id="dTarget">‚Äî</div>
          </div>
          <div class="box">
            <div class="k">‡∏≠‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡∏ö‡∏≤‡∏ó)</div>
            <div class="v" id="dSaved">‚Äî</div>
          </div>
          <div class="box">
            <div class="k">‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î (‡∏ö‡∏≤‡∏ó)</div>
            <div class="v" id="dRemain">‚Äî</div>
          </div>
        </div>

        <div class="modal-note" id="dNote"></div>

        <div class="actions">
          <button class="btn btn-doing" id="btnSetDoing">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‚Äù üíó</button>
          <button class="btn btn-fail" id="btnSetFail">‡∏ï‡∏¥‡πä‡∏Å ‚Äú‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‚Äù ü•∫</button>
          <button class="btn btn-ok" id="btnSetOk">‡∏ï‡∏¥‡πä‡∏Å ‚Äú‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‚Äù ‚úÖ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Modal -->
  <div class="overlay" id="createOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <h3>‡πÄ‡∏û‡∏¥‡πà‡∏° Goal ‡πÉ‡∏´‡∏°‡πà ‚ú®</h3>
        <button class="x" id="btnCloseCreate">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="form">
          <div class="full">
            <div class="label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div>
            <input class="input" id="cTitle" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô ‚úàÔ∏è">
          </div>

          <div>
            <div class="label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</div>
            <select class="select" id="cType">
              <option value="money">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</option>
              <option value="general">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
            </select>
            <div class="hint">‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‚Äù ‚Üí ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏°‡πÉ‡∏ô Savings</div>
          </div>

          <div>
            <div class="label">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div>
            <input class="input" id="cDue" type="date">
          </div>

          <div id="targetWrap">
            <div class="label">‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</div>
            <input class="input" id="cTarget" type="number" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 50000">
          </div>

          <div class="full">
            <div class="label">‡πÇ‡∏ô‡πâ‡∏ï (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</div>
            <textarea class="textarea" id="cNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÑ‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡∏±‡∏ö‡πÄ‡∏ö‡∏ö‡∏µ‡πã üíó"></textarea>
          </div>

          <div class="full" style="display:flex;justify-content:flex-end;gap:10px;">
            <button class="btn btn-doing" id="btnCreateCancel" type="button">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn btn-ok" id="btnCreate" type="button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
        </div>

        <div id="createMsg" class="hint" style="margin-top:10px;color:rgba(255,71,87,.95);font-weight:900;"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from "./assets/supabase.js";

    const $ = (id) => document.getElementById(id);

    const goalsGrid = $("goalsGrid");

    const detailOverlay = $("detailOverlay");
    const createOverlay = $("createOverlay");

    const btnOpenCreate = $("btnOpenCreate");
    const btnCloseDetail = $("btnCloseDetail");
    const btnCloseCreate = $("btnCloseCreate");
    const btnCreateCancel = $("btnCreateCancel");

    const cTitle = $("cTitle");
    const cType  = $("cType");
    const cDue   = $("cDue");
    const cTarget= $("cTarget");
    const cNote  = $("cNote");
    const targetWrap = $("targetWrap");
    const createMsg = $("createMsg");

    const dTitle = $("dTitle");
    const dType = $("dType");
    const dDue = $("dDue");
    const dStatus = $("dStatus");
    const dNote = $("dNote");
    const moneyRow = $("moneyRow");
    const dTarget = $("dTarget");
    const dSaved = $("dSaved");
    const dRemain= $("dRemain");

    const btnSetDoing = $("btnSetDoing");
    const btnSetFail  = $("btnSetFail");
    const btnSetOk    = $("btnSetOk");

    let goals = [];
    let selectedGoal = null;
    let goalSavedMap = new Map(); // goalId -> saved sum

    function money(n){
      const x = Number(n || 0);
      return x.toLocaleString("th-TH");
    }
    function dateNice(d){
      if (!d) return "‚Äî";
      const dt = new Date(d);
      if (Number.isNaN(dt.getTime())) return String(d);
      return dt.toLocaleDateString("th-TH", { year:"numeric", month:"short", day:"2-digit" });
    }
    function pillClass(status){
      if (status === "success") return "pill ok";
      if (status === "fail") return "pill fail";
      return "pill";
    }
    function statusText(status){
      if (status === "success") return "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ";
      if (status === "fail") return "‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ü•∫";
      return "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ üíó";
    }
    function typeText(t){
      return t === "money" ? "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô" : "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
    }

    function openOverlay(el){ el.classList.add("show"); el.setAttribute("aria-hidden","false"); }
    function closeOverlay(el){ el.classList.remove("show"); el.setAttribute("aria-hidden","true"); }

    function wireTypeToggle(){
      const t = cType.value;
      targetWrap.style.display = (t === "money") ? "block" : "none";
    }

    async function requireSession(){
      const { data } = await supabase.auth.getSession();
      if (!data.session){
        window.location.href = "index.html";
        return null;
      }
      return data.session;
    }

    async function loadGoals(){
      // goals
      const { data: g, error: ge } = await supabase
        .from("goals")
        .select("*")
        .order("due_date", { ascending: true, nullsFirst: false })
        .order("created_at", { ascending: false });

      if (ge) throw ge;
      goals = g || [];

      // savings sums by goal_id
      const { data: sums, error: se } = await supabase
        .from("savings")
        .select("goal_id, amount");

      if (se) throw se;

      goalSavedMap = new Map();
      (sums || []).forEach(r => {
        const k = r.goal_id || null;
        if (!k) return;
        const prev = Number(goalSavedMap.get(k) || 0);
        goalSavedMap.set(k, prev + Number(r.amount || 0));
      });
    }

    function render(){
      if (!goals.length){
        goalsGrid.innerHTML = `
          <div class="card" style="grid-column:1/-1;cursor:default;">
            <div class="title">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Goals</div>
            <div class="note">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <b>+ ‡πÄ‡∏û‡∏¥‡πà‡∏° Goal</b> ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞ üíó</div>
          </div>
        `;
        return;
      }

      goalsGrid.innerHTML = goals.map(g => {
        const status = g.status || "doing";
        const type = g.type || "money";
        const saved = Number(goalSavedMap.get(g.id) || 0);
        const target = Number(g.target_amount || 0);
        const hasMoney = type === "money" && target > 0;

        const remain = hasMoney ? Math.max(0, target - saved) : 0;
        const pct = hasMoney ? Math.min(100, (saved / target) * 100) : 0;

        return `
          <div class="card" data-id="${g.id}">
            <div class="${pillClass(status)}">${statusText(status)}</div>
            <div class="title">${escapeHtml(g.title || "Goal")}</div>

            <div class="meta">
              <span class="tag">üß© <b>${typeText(type)}</b></span>
              <span class="tag">üìÖ <b>${dateNice(g.due_date)}</b></span>
              ${hasMoney ? `<span class="tag">üí∞ <b>${money(saved)}</b> / ${money(target)}</span>` : ``}
              ${hasMoney ? `<span class="tag">üßæ <b>‡∏Ç‡∏≤‡∏î</b> ${money(remain)}</span>` : ``}
            </div>

            <div class="note">${escapeHtml(g.note || "")}</div>

            ${hasMoney ? `
              <div class="progress"><div class="bar" style="width:${pct.toFixed(1)}%"></div></div>
            ` : ``}
          </div>
        `;
      }).join("");

      goalsGrid.querySelectorAll(".card[data-id]").forEach(el => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-id");
          const g = goals.find(x => x.id === id);
          if (g) openGoalDetail(g);
        });
      });
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function openGoalDetail(g){
      selectedGoal = g;

      const type = g.type || "money";
      const status = g.status || "doing";

      dTitle.textContent = g.title || "Goal";
      dType.textContent = typeText(type);
      dDue.textContent  = dateNice(g.due_date);
      dStatus.textContent = statusText(status);
      dNote.textContent = g.note || "‚Äî";

      const target = Number(g.target_amount || 0);
      const saved  = Number(goalSavedMap.get(g.id) || 0);
      const hasMoney = (type === "money" && target > 0);

      if (hasMoney){
        moneyRow.style.display = "grid";
        dTarget.textContent = money(target);
        dSaved.textContent  = money(saved);
        dRemain.textContent = money(Math.max(0, target - saved));
      } else {
        moneyRow.style.display = "none";
      }

      openOverlay(detailOverlay);
    }

    async function setStatus(next){
      if (!selectedGoal) return;
      const { error } = await supabase.from("goals")
        .update({ status: next })
        .eq("id", selectedGoal.id);

      if (error) {
        alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
        return;
      }
      closeOverlay(detailOverlay);
      await boot();
    }

    async function createGoal(){
      createMsg.textContent = "";
      const title = (cTitle.value || "").trim();
      const type = cType.value;
      const due = cDue.value || null;
      const note = (cNote.value || "").trim() || null;

      let target_amount = null;
      if (type === "money"){
        const t = Number(cTarget.value || 0);
        target_amount = (t > 0) ? t : null;
      }

      if (!title){
        createMsg.textContent = "‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡πâ‡∏≤ üíó";
        return;
      }

      const payload = {
        title,
        type,
        due_date: due,
        target_amount,
        note,
        status: "doing",
      };

      const { error } = await supabase.from("goals").insert(payload);
      if (error){
        createMsg.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message;
        return;
      }

      // reset
      cTitle.value = "";
      cDue.value = "";
      cTarget.value = "";
      cNote.value = "";
      cType.value = "money";
      wireTypeToggle();

      closeOverlay(createOverlay);
      await boot();
    }

    function wire(){
      btnOpenCreate.addEventListener("click", () => openOverlay(createOverlay));
      btnCloseDetail.addEventListener("click", () => closeOverlay(detailOverlay));
      btnCloseCreate.addEventListener("click", () => closeOverlay(createOverlay));
      btnCreateCancel.addEventListener("click", () => closeOverlay(createOverlay));

      $("btnCreate").addEventListener("click", createGoal);

      cType.addEventListener("change", wireTypeToggle);
      wireTypeToggle();

      btnSetDoing.addEventListener("click", () => setStatus("doing"));
      btnSetFail.addEventListener("click", () => setStatus("fail"));
      btnSetOk.addEventListener("click", () => setStatus("success"));

      window.addEventListener("click", (e) => {
        if (e.target === detailOverlay) closeOverlay(detailOverlay);
        if (e.target === createOverlay) closeOverlay(createOverlay);
      });

      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape"){
          closeOverlay(detailOverlay);
          closeOverlay(createOverlay);
        }
      });
    }

    async function boot(){
      const session = await requireSession();
      if (!session) return;

      await loadGoals();
      render();
    }

    wire();
    boot();
  </script>

  <script src="assets/app.js"></script>
</body>
</html>
