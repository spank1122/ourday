<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Savings üíó</title>

  <link rel="stylesheet" href="assets/theme.css">
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <meta property="og:title" content="Our Day üíó">
  <meta property="og:description" content="‡∏´‡∏°‡∏π‡∏≠‡πâ‡∏ß‡∏ô √ó ‡∏´‡∏°‡∏π‡∏à‡∏¥‡πã‡∏ß">
  <meta property="og:image" content="assets/og.png">
  <meta property="og:type" content="website">
  <meta name="theme-color" content="#ff5e9a">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body{
      min-height:100vh;
      font-family:Poppins, sans-serif;
      background: linear-gradient(135deg, #ffe6ee 0%, #fff0f7 50%, #ffe6ee 100%);
      padding:120px 20px 40px;
    }
    .wrap{ max-width: 1100px; margin: 0 auto; }

    .head{
      text-align:center;
      margin-bottom: 14px;
    }
    .h1{
      font-size: 2.1rem;
      color:#ff6b95;
      font-weight: 900;
      text-shadow: 0 18px 50px rgba(255,107,149,.18);
      line-height:1.15;
    }
    .sub{
      margin-top: 8px;
      color: rgba(255,94,154,.65);
      font-weight: 800;
      font-size: .95rem;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 14px;
    }

    .card{
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(255,107,149,.16);
      border-radius: 28px;
      padding: 18px;
      box-shadow: 0 18px 60px rgba(255,107,149,.16);
      backdrop-filter: blur(16px);
    }

    /* ===== Total + Water ===== */
    .totalRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      flex-wrap:wrap;
    }

    .waterWrap{
      width: 190px;
      height: 190px;
      border-radius: 999px;
      position: relative;
      overflow:hidden;
      border: 2px solid rgba(255,107,149,.22);
      background: rgba(255,255,255,.55);
      box-shadow: 0 30px 80px rgba(255,107,149,.22);
      flex: 0 0 auto;
    }
    .waterFill{
      position:absolute;
      left:0; right:0;
      bottom:0;
      height: 40%;
      background: linear-gradient(180deg, #ff5e9a 0%, #ff8ab9 55%, #ffd1e3 100%);
      filter: saturate(1.15);
      transition: height .35s ease;
    }

    /* wave overlay */
    .wave{
      position:absolute;
      left:-20%;
      width: 140%;
      height: 38px;
      top:-18px;
      background-repeat: repeat-x;
      opacity:.85;
      animation: waveMove 3.2s linear infinite;
      mix-blend-mode: screen;
      filter: blur(.1px);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='40' viewBox='0 0 120 40'%3E%3Cpath d='M0 20 C 15 6, 30 6, 45 20 C 60 34, 75 34, 90 20 C 105 6, 120 6, 135 20 L 135 40 L 0 40 Z' fill='rgba(255,255,255,0.70)'/%3E%3C/svg%3E");
    }
    .wave2{
      opacity:.55;
      top:-12px;
      animation-duration: 2.4s;
      filter: blur(.2px);
    }
    @keyframes waveMove{
      from { transform: translateX(0); }
      to   { transform: translateX(-120px); }
    }

    /* shimmer ripple */
    .ripple{
      position:absolute;
      inset:-30%;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 55%);
      animation: ripple 3.6s ease-in-out infinite;
      opacity: .9;
      pointer-events:none;
    }
    @keyframes ripple{
      0%{ transform: scale(.98); opacity:.75; }
      50%{ transform: scale(1.04); opacity:1; }
      100%{ transform: scale(.98); opacity:.75; }
    }

    .waterText{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 18px;
      z-index: 5;
    }
    .waterText .k{
      font-weight: 900;
      color: rgba(255,94,154,.75);
      font-size: .88rem;
      margin-bottom: 6px;
      text-shadow: 0 10px 25px rgba(255,107,149,.12);
    }
    .waterText .v{
      font-weight: 900;
      color: rgba(26,37,47,.85);
      font-size: 1.35rem;
      line-height:1.1;
    }
    .waterText .small{
      margin-top: 6px;
      font-weight: 800;
      color: rgba(26,37,47,.55);
      font-size: .86rem;
    }

    .sumBoxes{
      flex: 1 1 auto;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      min-width: 320px;
    }
    .mini{
      background: rgba(255,107,149,.06);
      border: 1px solid rgba(255,107,149,.14);
      border-radius: 22px;
      padding: 12px;
    }
    .mini .k{ color: rgba(255,94,154,.76); font-weight: 900; font-size: .82rem; }
    .mini .v{ margin-top: 6px; font-weight: 900; color: rgba(26,37,47,.85); font-size: 1.05rem; }

    /* ===== Add saving ===== */
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    .label{ color: rgba(255,94,154,.78); font-weight: 900; font-size:.85rem; margin-bottom: 6px; }
    .input, .select{
      width:100%;
      border-radius: 18px;
      border: 1px solid rgba(255,107,149,.18);
      padding: 12px 12px;
      font-family: inherit;
      outline: none;
      background: rgba(255,255,255,.9);
      font-weight: 750;
      color: rgba(26,37,47,.85);
    }

    .seg{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 6px;
    }
    .chip{
      cursor:pointer;
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 900;
      border: 1px solid rgba(255,107,149,.18);
      background: rgba(255,107,149,.08);
      color:#ff5e9a;
      transition:.16s ease;
    }
    .chip.active{
      background: linear-gradient(135deg,#ff5e9a,#ff8ab9);
      color:#fff;
      box-shadow: 0 14px 35px rgba(255,107,149,.22);
      border-color: rgba(255,107,149,.28);
    }

    .btn{
      border:none; cursor:pointer;
      border-radius: 999px;
      padding: 11px 14px;
      font-weight: 900;
      background: linear-gradient(135deg,#ff5e9a,#ff8ab9);
      color:#fff;
      box-shadow: 0 14px 35px rgba(255,107,149,.22);
      transition:.18s ease;
      margin-top: 10px;
    }
    .btn:hover{ transform: translateY(-2px); box-shadow: 0 18px 45px rgba(255,107,149,.30); }

    .msg{
      margin-top: 10px;
      font-weight: 900;
      color: rgba(255,71,87,.95);
      min-height: 20px;
    }
    .msg.ok{ color: rgba(46,204,113,.95); }

    /* list */
    .list{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 340px;
      overflow:auto;
      padding-right: 4px;
    }
    .item{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 22px;
      border: 1px solid rgba(255,107,149,.14);
      background: rgba(255,255,255,.75);
    }
    .item .left{
      display:flex; flex-direction:column; gap:4px;
      min-width: 0;
    }
    .item .t{
      font-weight: 900;
      color: rgba(26,37,47,.85);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 520px;
    }
    .item .s{
      font-weight: 800;
      color: rgba(26,37,47,.55);
      font-size: .86rem;
    }
    .item .amt{
      font-weight: 900;
      color:#ff5e9a;
      white-space:nowrap;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .sumBoxes{ grid-template-columns: 1fr; min-width: unset; }
      .row{ grid-template-columns: 1fr; }
      .waterWrap{ width: 170px; height:170px; }
      body{ padding-top: 110px; }
    }
  </style>
</head>

<body>
  <div id="appNav"></div>
  <div id="pageFade"></div>

  <div class="wrap">
    <div class="head">
      <div class="h1">Savings üíó</div>
      <div class="sub">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏£‡∏ß‡∏° = ‡∏ô‡∏±‡∏ö‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å Goal + ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° ‚ú®</div>
    </div>

    <div class="grid">
      <!-- TOTAL -->
      <div class="card">
        <div class="totalRow">
          <div class="waterWrap" aria-label="total savings water">
            <div class="ripple"></div>
            <div class="waterFill" id="waterFill">
              <div class="wave"></div>
              <div class="wave wave2"></div>
            </div>
            <div class="waterText">
              <div class="k">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏£‡∏ß‡∏°</div>
              <div class="v" id="totalSaved">0 ‡∏ø</div>
              <div class="small" id="totalHint">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>
            </div>
          </div>

          <div class="sumBoxes">
            <div class="mini">
              <div class="k">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</div>
              <div class="v" id="moneyGoalsCount">0</div>
            </div>
            <div class="mini">
              <div class="k">‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div>
              <div class="v" id="totalTarget">0</div>
            </div>
            <div class="mini">
              <div class="k">‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div>
              <div class="v" id="totalRemain">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ADD SAVING + LIST -->
      <div class="card">
        <div style="font-weight:900;color:#ff5e9a;font-size:1.05rem;margin-bottom:6px;">
          ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏° üíó
        </div>

        <div class="seg" role="tablist" aria-label="saving mode">
          <button class="chip active" id="chipTotal" type="button">‡∏≠‡∏≠‡∏°‡∏£‡∏ß‡∏°</button>
          <button class="chip" id="chipGoal" type="button">‡∏≠‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Goal (‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô)</button>
        </div>

        <div class="row" style="margin-top:12px;">
          <div>
            <div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</div>
            <input class="input" id="amount" type="number" min="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100">
          </div>

          <div id="goalPick" style="display:none;">
            <div class="label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Goal (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô)</div>
            <select class="select" id="goalSelect"></select>
          </div>

          <div>
            <div class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
            <input class="input" id="date" type="date">
          </div>

          <div>
            <div class="label">‡πÇ‡∏ô‡πâ‡∏ï (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</div>
            <input class="input" id="note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á üíó">
          </div>
        </div>

        <button class="btn" id="btnAdd">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <div class="msg" id="msg"></div>

        <div style="margin-top:14px;font-weight:900;color:rgba(255,94,154,.78);">
          ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        </div>
        <div class="list" id="list"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from "./assets/supabase.js";

    const $ = (id) => document.getElementById(id);

    const chipTotal = $("chipTotal");
    const chipGoal = $("chipGoal");
    const goalPick = $("goalPick");
    const goalSelect = $("goalSelect");

    const amountEl = $("amount");
    const dateEl = $("date");
    const noteEl = $("note");
    const btnAdd = $("btnAdd");
    const msgEl = $("msg");

    const listEl = $("list");

    const totalSavedEl = $("totalSaved");
    const totalHintEl = $("totalHint");
    const moneyGoalsCountEl = $("moneyGoalsCount");
    const totalTargetEl = $("totalTarget");
    const totalRemainEl = $("totalRemain");
    const waterFillEl = $("waterFill");

    let mode = "total"; // total | goal
    let goalsMoney = [];
    let goalsAll = [];
    let savings = [];

    function money(n){
      return Number(n || 0).toLocaleString("th-TH");
    }
    function todayISO(){
      const d = new Date();
      const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
      return z.toISOString().slice(0,10);
    }

    function setMsg(text, ok=false){
      msgEl.textContent = text || "";
      msgEl.classList.toggle("ok", !!ok);
    }

    function setMode(next){
      mode = next;
      chipTotal.classList.toggle("active", mode==="total");
      chipGoal.classList.toggle("active", mode==="goal");
      goalPick.style.display = (mode==="goal") ? "block" : "none";
    }

    async function requireSession(){
      const { data } = await supabase.auth.getSession();
      if (!data.session){
        window.location.href = "index.html";
        return null;
      }
      return data.session;
    }

    async function loadGoals(){
      const { data, error } = await supabase
        .from("goals")
        .select("*")
        .order("due_date", { ascending: true, nullsFirst: false })
        .order("created_at", { ascending: false });
      if (error) throw error;

      goalsAll = data || [];
      goalsMoney = goalsAll
        .filter(g => (g.type || "money") === "money" && Number(g.target_amount || 0) > 0);

      goalSelect.innerHTML = goalsMoney.length
        ? goalsMoney.map(g => `<option value="${g.id}">${escapeHtml(g.title)} (${g.due_date || "‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î"})</option>`).join("")
        : `<option value="">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Goal ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</option>`;
    }

    async function loadSavings(){
      const { data, error } = await supabase
        .from("savings")
        .select("*")
        .order("date", { ascending: false })
        .order("created_at", { ascending: false })
        .limit(40);
      if (error) throw error;
      savings = data || [];
    }

    function sumAllSavings(){
      return savings.reduce((acc, r) => acc + Number(r.amount || 0), 0);
    }

    function sumByGoal(goalId){
      return savings
        .filter(s => s.goal_id === goalId)
        .reduce((acc, r) => acc + Number(r.amount || 0), 0);
    }

    function calcTotals(){
      // ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ goalsMoney
      const totalTarget = goalsMoney.reduce((acc, g) => acc + Number(g.target_amount || 0), 0);

      // saved per goal money
      const totalSavedForMoneyGoals = goalsMoney.reduce((acc, g) => acc + sumByGoal(g.id), 0);

      // ‡πÅ‡∏ï‡πà ‚Äú‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏£‡∏ß‡∏°‚Äù ‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏ö‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å Goal / ‡∏ó‡∏∏‡∏Å‡∏≠‡∏≠‡∏° (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á)
      const totalSavedAll = sumAllSavings();

      // remain ‡∏£‡∏ß‡∏° (‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ goalsMoney)
      const totalRemain = goalsMoney.reduce((acc, g) => {
        const target = Number(g.target_amount || 0);
        const saved = sumByGoal(g.id);
        return acc + Math.max(0, target - saved);
      }, 0);

      return { totalSavedAll, totalTarget, totalRemain, totalSavedForMoneyGoals };
    }

    function setWaterBy(totalSavedAll, totalTarget){
      // ‡πÉ‡∏ä‡πâ totalTarget ‡∏Ç‡∏≠‡∏á ‚Äú‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‚Äù ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥ (‡∏î‡∏π cute)
      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ target ‡πÄ‡∏•‡∏¢ ‚Üí ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏™‡πÄ‡∏ï‡πá‡∏õ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å
      let pct = 0;
      if (Number(totalTarget) > 0){
        pct = Math.min(100, (Number(totalSavedAll) / Number(totalTarget)) * 100);
      } else {
        // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‚Üí ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏ö‡∏ö‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡πÄ‡∏ï‡πá‡∏õ
        pct = Math.min(100, Math.log10(1 + Number(totalSavedAll)) * 35);
      }

      // ‡∏Å‡∏±‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ô‡πâ‡∏≥
      const h = Math.max(8, Math.min(100, pct));
      waterFillEl.style.height = h.toFixed(1) + "%";

      totalHintEl.textContent =
        Number(totalTarget) > 0
          ? `‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ${pct.toFixed(1)}% ‡∏Ç‡∏≠‡∏á ‚Äú‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‚Äù ‚ú®`
          : `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡πÄ‡∏•‡∏¢‡πÇ‡∏ä‡∏ß‡πå‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏≠‡∏≠‡∏°‡∏£‡∏ß‡∏° üíó`;
    }

    function renderTotals(){
      const { totalSavedAll, totalTarget, totalRemain } = calcTotals();

      totalSavedEl.textContent = `${money(totalSavedAll)} ‡∏ø`;
      moneyGoalsCountEl.textContent = `${goalsMoney.length}`;
      totalTargetEl.textContent = money(totalTarget);
      totalRemainEl.textContent = money(totalRemain);

      setWaterBy(totalSavedAll, totalTarget);
    }

    function renderList(){
      if (!savings.length){
        listEl.innerHTML = `
          <div class="item">
            <div class="left">
              <div class="t">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°</div>
              <div class="s">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡πâ‡∏≤ üíó</div>
            </div>
            <div class="amt">0 ‡∏ø</div>
          </div>
        `;
        return;
      }

      const goalMap = new Map(goalsAll.map(g => [g.id, g.title]));
      listEl.innerHTML = savings.map(s => {
        const isTotal = !s.goal_id;
        const goalName = isTotal ? "‡∏≠‡∏≠‡∏°‡∏£‡∏ß‡∏°" : (goalMap.get(s.goal_id) || "Goal");
        const date = s.date ? new Date(s.date).toLocaleDateString("th-TH", { year:"numeric", month:"short", day:"2-digit" }) : "‚Äî";
        const note = s.note ? ` ‚Ä¢ ${escapeHtml(s.note)}` : "";
        return `
          <div class="item">
            <div class="left">
              <div class="t">${escapeHtml(goalName)}</div>
              <div class="s">${date}${note}</div>
            </div>
            <div class="amt">+ ${money(s.amount)} ‡∏ø</div>
          </div>
        `;
      }).join("");
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function addSaving(){
      setMsg("");

      const amt = Number(amountEl.value || 0);
      const date = dateEl.value || todayISO();
      const note = (noteEl.value || "").trim() || null;

      if (!amt || amt <= 0){
        setMsg("‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡πâ‡∏≤ üíó");
        return;
      }

      let goal_id = null;
      if (mode === "goal"){
        const gid = goalSelect.value;
        if (!gid){
          setMsg("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Goal ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ü•∫", false);
          return;
        }
        goal_id = gid;
      }

      const payload = {
        amount: amt,
        date,
        note,
        goal_id, // null = ‡∏≠‡∏≠‡∏°‡∏£‡∏ß‡∏°
      };

      const { error } = await supabase.from("savings").insert(payload);
      if (error){
        setMsg("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
        return;
      }

      amountEl.value = "";
      noteEl.value = "";
      dateEl.value = todayISO();

      setMsg("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß üíó", true);
      await boot();
    }

    function wire(){
      chipTotal.addEventListener("click", () => setMode("total"));
      chipGoal.addEventListener("click", () => setMode("goal"));
      btnAdd.addEventListener("click", addSaving);

      dateEl.value = todayISO();
      setMode("total");
    }

    async function boot(){
      const session = await requireSession();
      if (!session) return;

      await loadGoals();
      await loadSavings();
      renderTotals();
      renderList();

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î goal ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ goal money ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ total
      if (mode === "goal" && !goalsMoney.length){
        setMode("total");
      }
    }

    wire();
    boot();
  </script>

  <script src="assets/app.js"></script>
</body>
</html>
